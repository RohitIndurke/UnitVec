<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ongoing Exam â€” unitVec</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="../css/index.css">
    <style>
        .exam-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: var(--spacing-md);
            min-height: 80vh;
            align-items: start;
        }

        .question-box {
            background: var(--color-white);
            border: 2px solid var(--color-black);
            padding: var(--spacing-lg);
            position: relative;
        }

        .question-number {
            font-family: var(--font-heading);
            font-size: 0.8rem;
            background: var(--color-yellow);
            padding: 4px 12px;
            display: inline-block;
            margin-bottom: var(--spacing-sm);
            border: 2px solid var(--color-black);
        }

        .option-item {
            display: block;
            padding: 1rem;
            border: 1px solid var(--color-black);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: none;
            /* Instant snap as per user request */
        }

        .option-item:hover {
            background: var(--color-offwhite);
        }

        .option-item input {
            display: none;
        }

        .option-item.selected {
            background: var(--color-yellow);
            border: 2px solid var(--color-black);
            font-weight: 700;
        }

        .timer-sidebar {
            background: var(--color-black);
            color: var(--color-white);
            padding: var(--spacing-md);
            border: 2px solid var(--color-black);
            position: sticky;
            top: 100px;
        }

        .timer-display {
            font-family: var(--font-heading);
            font-size: 2.5rem;
            margin-bottom: var(--spacing-sm);
            color: var(--color-yellow);
        }

        .progress-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: var(--spacing-md);
        }

        .dot {
            width: 30px;
            height: 30px;
            border: 1px solid var(--color-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .dot.active {
            background: var(--color-yellow);
            color: var(--color-black);
            border-color: var(--color-yellow);
        }

        .dot.answered {
            background: var(--color-white);
            color: var(--color-black);
        }

        @media (max-width: 992px) {
            .exam-layout {
                grid-template-columns: 1fr;
            }

            .timer-sidebar {
                position: static;
                order: -1;
            }
        }
    </style>
</head>

<body style="background-color: var(--color-offwhite);">
    <!-- Navigation (Simplified) -->
    <header class="nav" id="main-nav" style="padding: 0.5rem 0;">
        <div class="container nav__container">
            <span class="nav__logo">unitVec</span>
            <div id="exam-title" style="font-family: var(--font-heading); font-weight: 700;">Loading Exam...</div>
        </div>
    </header>

    <main class="container" style="margin-top: 120px; margin-bottom: var(--spacing-xl);">
        <div class="exam-layout">
            <!-- Question Content -->
            <div id="question-container">
                <div class="question-box" id="q-box" style="display: none;">
                    <div class="question-number">Question <span id="current-q-index">1</span></div>
                    <h2 id="question-text"
                        style="font-size: 1.5rem; text-transform: none; margin-bottom: var(--spacing-md);"></h2>

                    <div id="options-list">
                        <!-- Options will be injected here -->
                    </div>

                    <div class="hero__cta" style="justify-content: space-between; margin-top: var(--spacing-lg);">
                        <button class="btn btn--outline" id="prev-btn" style="padding: 0.8rem 1.5rem;">Previous</button>
                        <button class="btn btn--primary" id="next-btn" style="padding: 0.8rem 1.5rem;">Next
                            Question</button>
                    </div>
                </div>

                <div id="loading-state" class="text-center">
                    <h2 style="opacity: 0.5;">Accessing Secure Test Environment...</h2>
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="timer-sidebar">
                <p style="text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.1em; opacity: 0.7;">Time
                    Remaining</p>
                <div class="timer-display" id="timer">00:00</div>
                <div id="student-info" style="font-size: 0.8rem; margin-bottom: var(--spacing-md);">
                    <p id="display-name">---</p>
                    <p id="display-roll" style="opacity: 0.6;">---</p>
                </div>

                <hr style="border-color: rgba(255,255,255,0.1); margin: var(--spacing-sm) 0;">

                <p style="text-transform: uppercase; font-size: 0.7rem; font-weight: 700;">Progress</p>
                <div class="progress-dots" id="dots-container"></div>

                <button class="btn btn--outline" id="final-submit-btn"
                    style="width: 100%; border-color: var(--color-yellow); color: var(--color-yellow); margin-top: var(--spacing-md);">Submit
                    Exam</button>
            </aside>
        </div>
    </main>

    <script>
        let questions = [];
        let currentIndex = 0;
        let answers = {};
        let timeRemaining = 0;
        let timerInterval;

        const examCode = localStorage.getItem("currentExamCode");
        const studentId = localStorage.getItem("user_id");
        const studentName = localStorage.getItem("currentStudentName");

        if (!examCode || !studentId) {
            alert("Session expired or invalid. Please login again.");
            window.location.href = "exam.html";
        }

        document.getElementById('display-name').innerText = studentName || "Student";

        async function initExam() {
            try {
                const response = await fetch(`http://localhost:3000/exams/${examCode}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                questions = data.questions;
                document.getElementById('exam-title').innerText = data.exam.title;
                timeRemaining = data.exam.duration_minutes * 60;

                // Setup Dots
                const dotsContainer = document.getElementById('dots-container');
                questions.forEach((_, i) => {
                    const dot = document.createElement('div');
                    dot.className = 'dot';
                    dot.innerText = i + 1;
                    dot.onclick = () => renderQuestion(i);
                    dotsContainer.appendChild(dot);
                });

                renderQuestion(0);
                startTimer();

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('q-box').style.display = 'block';
            } catch (err) {
                console.error(err);
                alert("Failed to load exam data. Please check your connection.");
            }
        }

        function renderQuestion(index) {
            currentIndex = index;
            const q = questions[index];
            document.getElementById('current-q-index').innerText = index + 1;
            document.getElementById('question-text').innerText = q.question_text;

            const optionsContainer = document.getElementById('options-list');
            optionsContainer.innerHTML = '';

            // Handle options JSON (it might be a string or array depending on PHP config)
            let options = q.options;
            if (typeof options === 'string') options = JSON.parse(options);

            options.forEach((opt, i) => {
                const optElement = document.createElement('div');
                optElement.className = `option-item ${answers[q.question_id] === (i + 1) ? 'selected' : ''}`;
                optElement.innerHTML = `
                    <input type="radio" name="option" value="${i + 1}" ${answers[q.question_id] === (i + 1) ? 'checked' : ''}>
                    ${opt}
                `;
                optElement.onclick = () => selectOption(q.question_id, i + 1);
                optionsContainer.appendChild(optElement);
            });

            // Update Dot UI
            document.querySelectorAll('.dot').forEach((d, i) => {
                d.classList.remove('active');
                if (i === index) d.classList.add('active');
                if (answers[questions[i].question_id]) d.classList.add('answered');
            });

            // Update buttons
            document.getElementById('prev-btn').disabled = (index === 0);
            document.getElementById('next-btn').innerText = (index === questions.length - 1) ? "Review All" : "Next Question";
            document.getElementById('next-btn').onclick = (index === questions.length - 1) ? () => { } : () => renderQuestion(index + 1);
        }

        function selectOption(qId, val) {
            answers[qId] = val;
            renderQuestion(currentIndex);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    autoSubmit();
                    return;
                }
                timeRemaining--;
                const mins = Math.floor(timeRemaining / 60);
                const secs = timeRemaining % 60;
                document.getElementById('timer').innerText =
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                if (timeRemaining < 60) document.getElementById('timer').style.color = '#ff0000';
            }, 1000);
        }

        async function submitExam() {
            if (!confirm("Are you sure you want to submit your answers?")) return;

            clearInterval(timerInterval);
            const payload = {
                student_id: studentId,
                exam_code: examCode,
                answers: answers
            };

            try {
                const response = await fetch("http://localhost:3000/results/submit", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.success) {
                    localStorage.setItem("lastScore", data.score);
                    localStorage.setItem("maxScore", data.total);
                    window.location.href = "end.html";
                } else {
                    alert("Submission failed: " + data.error);
                }
            } catch (err) {
                alert("Network error occurred during submission.");
            }
        }

        async function autoSubmit() {
            alert("Time is up! Submitting your answers automatically.");
            // Similar to submitExam but without confirmation
            const payload = {
                student_id: studentId,
                exam_code: examCode,
                answers: answers
            };
            await fetch("http://localhost:3000/results/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            window.location.href = "end.html";
        }

        document.getElementById('prev-btn').onclick = () => renderQuestion(currentIndex - 1);
        document.getElementById('final-submit-btn').onclick = submitExam;

        initExam();
    </script>
</body>

</html>